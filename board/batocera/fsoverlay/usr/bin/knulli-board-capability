#!/bin/sh


CAPABILITIES_FILE="/boot/boot/batocera.board.capability"
BOARD_FILE="/boot/boot/batocera.board"

HAS_CAPABILITY=false

CAPABILITY=$1

if [ -z "$CAPABILITY" ]; then
    echo "Usage: $0 <rgb|lid|hdmi|wifi|bluetooth|adb>"
    exit 1
fi

# Examine capability file to check if the board has the given capability.
checkCapabilityFile() {
    CAPABILITIES=$(cat $CAPABILITIES_FILE)
    if echo "$CAPABILITIES" | grep -q "$CAPABILITY"; then
        HAS_CAPABILITY=true
    fi
}

# Read board file and determine hard-coded capabilities by board name.
checkCapabilityByBoard() {
    BOARD=$(cat $BOARD_FILE)
    if [ "$CAPABILITY" = "rgb" ]; then
        if [ "$BOARD" = "rg40xx-h" ] || [ "$BOARD" = "rg40xx-v" ] || [ "$BOARD" = "rg-cubexx" ] || [ "$BOARD" = "trimui-smart-pro" ] || [ "$BOARD" = "trimui-brick" ]; then
            HAS_CAPABILITY=true
        fi
    elif [ "$CAPABILITY" = "hdmi" ]; then
        if [ "$BOARD" = "rg35xx-plus" ] || [ "$BOARD" = "rg35xx-h" ] || [ "$BOARD" = "rg35xx-2024" ] || [ "$BOARD" = "rg35xx-sp" ] || [ "$BOARD" = "rg28xx" ] || [ "$BOARD" = "rg40xx-h" ] || [ "$BOARD" = "rg40xx-v" ] || [ "$BOARD" = "rg-cubexx" ]; then
            HAS_CAPABILITY=true
        fi
    elif [ "$CAPABILITY" = "lid" ]; then
        if [ "$BOARD" = "rg35xx-sp" ]; then
            HAS_CAPABILITY=true
        fi
    elif [ "$CAPABILITY" = "wifi" ]; then
        if [ "$BOARD" = "rg35xx-plus" ] || [ "$BOARD" = "rg35xx-h" ] || [ "$BOARD" = "rg35xx-sp" ] || [ "$BOARD" = "rg40xx-h" ] || [ "$BOARD" = "rg40xx-v" ] || [ "$BOARD" = "rg-cubexx" ] || [ "$BOARD" = "trimui-smart-pro" ] || [ "$BOARD" = "trimui-brick" ]; then
            HAS_CAPABILITY=true
        fi
    elif [ "$CAPABILITY" = "bluetooth" ]; then
        if [ "$BOARD" = "rg35xx-plus" ] || [ "$BOARD" = "rg35xx-h" ] || [ "$BOARD" = "rg35xx-sp" ] || [ "$BOARD" = "rg40xx-h" ] || [ "$BOARD" = "rg40xx-v" ] || [ "$BOARD" = "rg-cubexx" ] || [ "$BOARD" = "trimui-smart-pro" ] || [ "$BOARD" = "trimui-brick" ]; then
            HAS_CAPABILITY=true
        fi
    elif [ "$CAPABILITY" = "adb" ]; then
        if [ "$BOARD" = "rg35xx-plus" ] || [ "$BOARD" = "rg35xx-h" ] || [ "$BOARD" = "rg35xx-2024" ] || [ "$BOARD" = "rg35xx-sp" ] || [ "$BOARD" = "rg28xx" ] || [ "$BOARD" = "rg40xx-h" ] || [ "$BOARD" = "rg40xx-v" ] || [ "$BOARD" = "rg-cubexx" ] || [ "$BOARD" = "trimui-smart-pro" ] || [ "$BOARD" = "trimui-brick" ]; then
            HAS_CAPABILITY=true
        fi
    fi

}

if [ -f $CAPABILITIES_FILE ]; then
    # If a capabilities file exists, check for the capability
    # inside the capabilities file.
    checkCapabilityFile
else
    # If capabilities file does not exists, check for the
    # capability by board name.
    checkCapabilityByBoard
fi

if $HAS_CAPABILITY; then
    echo "true"
    exit 0
else
    echo "false"
    exit 1
fi
