#!/bin/bash

# ScummVM ini file locations
LIBRETRO_SCUMMVM_INI="/userdata/bios/scummvm.ini"
STANDALONE_SCUMMVM_INI="/userdata/system/.config/scummvm/scummvm.ini"

if [ ! -f "$LIBRETRO_SCUMMVM_INI" ]; then
  echo "$LIBRETRO_SCUMMVM_INI missing - creating file."
  touch "$LIBRETRO_SCUMMVM_INI"
fi

if [ ! -f "$STANDALONE_SCUMMVM_INI" ]; then
  echo "$STANDALONE_SCUMMVM_INI missing - creating file."
  touch "$STANDALONE_SCUMMVM_INI"
fi

if [ ! -d "$1" ]; then
    echo "$1 does not exist. Aborting."
    exit 1
elif [ -z "$(ls -A "$1")" ]; then
    echo "Directory $1 is empty. Nothing to do here."
    exit 1
elif ls $1/*.scummvm 1> /dev/null 2>&1; then
    echo "Directory $1 already has a scummvm file. Nothing to do here."
    exit 1
fi

echo "$1 has no ScummVM file, yet - attempting game detection."


# Add game to libretro ScummVM config and memorize the game target name
GAME_TARGET="$(scummvm -c "$LIBRETRO_SCUMMVM_INI" -p "$1" --add | sed -En "s/[ ]*Target:[ ]*(.*)/\1/p")"

if [ -z "$GAME_TARGET" ]; then
  echo "No new ScummVM game found in $1 - aborting."
  exit 1
fi

echo "Detected $GAME_TARGET in $1"

# Add the game also to the Standalone ScummVM configuration (and hide output)
scummvm -c "$STANDALONE_SCUMMVM_INI" -p "$1" --add > /dev/null 2>&1;

# Create *.scummvm file for EmulationStation
echo "$GAME_TARGET" > "$1/$GAME_TARGET.scummvm"
echo "Created $1/$GAME_TARGET.scummvm"

exit 0
