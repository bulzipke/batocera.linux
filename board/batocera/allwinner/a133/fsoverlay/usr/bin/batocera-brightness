#!/bin/sh

# Stored brightness value when the display is turned off.
VALPATH=/var/run/$(basename "$0")

XMAX=255
XMIN=3

CYCLESTEP=20 # % additional brightbess at each step

getValue() {
    if [ -e "${VALPATH}" ]; then
        cat "${VALPATH}"
    else
        brightness get
    fi
}

setValue() {
    NEWVAL=$1

    test "${NEWVAL}" -lt 0         && NEWVAL=0
    test "${NEWVAL}" -gt "${XMAX}" && NEWVAL="${XMAX}"

    if [ -e "${VALPATH}" ]; then
        echo "${NEWVAL}" > "${VALPATH}"
    else
        brightness set "${NEWVAL}"
    fi
}

cycle() {
    X=$(getValue)
    FVALUE=$(echo "scale=3;${X}" "*" "100" / "${XMAX}" | bc)
    LC_ALL=C FVALUE=$(printf '%.*f\n' 0 "${FVALUE}") # round
    NEWVAL=$(echo "${FVALUE} + ${CYCLESTEP}" | bc)
    [ "${NEWVAL}" -gt 100 ] && NEWVAL=0
    echo "Brightness cycling to ${NEWVAL}%"
    NEWVAL=$(expr "${NEWVAL}" "*" "${XMAX}" / 100)
    setValue "${NEWVAL}" "${XMAX}"
    exit 0
}

display_off() {
    if [ ! -e "${VALPATH}" ]; then
        brightness get > "${VALPATH}"
        brightness set 0
    fi
    exit 0
}

display_on() {
    if [ -e "${VALPATH}" ]; then
        brightness set "$(cat "${VALPATH}")"
        rm -f "${VALPATH}"
    fi
    exit 0
}

# get
if test $# = 0
then
    X=$(getValue)
    FVALUE=$(echo "scale=3;${X}" "*" "100" / "${XMAX}" | bc)
    LC_ALL=C printf '%.*f\n' 0 "${FVALUE}" # round
    exit 0
fi

# set
if test $# = 1
then
    if [ "${1}" = "cycle" ]; then
        cycle
    elif [ "${1}" = "dispoff" ]; then
        display_off
    elif [ "${1}" = "dispon" ]; then
        display_on
    else
       NEWVAL=$(expr "${1}" "*" "${XMAX}" / 100)
       setValue "${NEWVAL}" "${XMAX}"
       exit 0
    fi
fi

# set +/-
if test $# = 2
then
    X=$(getValue)
    DELTA=$(expr "${2}" '*' ${XMAX} / 100)

    if [ "${1}" = "+" ]; then

        if [ "${X}" -eq 0 ]; then
            NEWVAL=${XMIN}
        else
            NEWVAL=$(expr "${X}" "+" "${DELTA}")
        fi

    elif [ "${1}" = "-" ]; then

        NEWVAL=$(expr "${X}" "-" "${DELTA}")

        if [ "${NEWVAL}" -lt "${XMIN}" ] && [ "${X}" -ne "${XMIN}" ] && [ "${X}" -ne 0 ]; then
            NEWVAL=${XMIN}
        fi
    fi

    setValue "${NEWVAL}" "${XMAX}"
    exit 0
fi

# help
echo "${0}"      >&2
echo "${0} + 10" >&2
echo "${0} - 20" >&2
echo "${0} cycle" >&2
exit 1
